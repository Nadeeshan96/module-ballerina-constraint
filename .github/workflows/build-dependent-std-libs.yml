name: Build Dependent Standard Libraries

on:
    workflow_dispatch:
        inputs:
            timestamped_version:
                description: Module timestamped version
                required: true
            target_branch:
                description: Target branch of the dependent module
                required: false
            ballerina_modules:
                description: Dependent Ballerina modules
                required: false
                default: "['http', 'websocket', 'graphql']"
            ballerinax_modules:
                description: Dependent Ballerina extended modules
                required: false
                default: "['rabbitmq', 'nats', 'kafka']"

jobs:
    build-ballerina-modules:
        if: inputs.ballerina_modules != ''
        name: Build Ballerina Module
        continue-on-error: true
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                module: ${{ fromJson(inputs.ballerina_modules) }}
        steps:
            - name: Set up JDK 11
              uses: actions/setup-java@v3
              with:
                  distribution: 'temurin'
                  java-version: 11

            - name: Checkout dependent Ballerina module
              uses: actions/checkout@v3
              id: checkout
              if: ${{ inputs.target_branch != '' }}
              continue-on-error: true
              with:
                  repository: 'ballerina-platform/module-ballerina-${{ matrix.module }}'
                  ref: ${{ inputs.target_branch }}

            - name: Checkout default branch
              uses: actions/checkout@v3
              if: ${{ inputs.target_branch == '' || steps.checkout.outcome == 'failure' }}
              continue-on-error: true
              with:
                  repository: 'ballerina-platform/module-ballerina-${{ matrix.module }}'

            - name: Change constraint module version
              run: |
                  CONSTRAINT_VERSION=${{ inputs.timestamped_version }}
                  echo CONSTRAINTVERSION=$CONSTRAINT_VERSION
                  sed -i "s/stdlibConstraintVersion=\(.*\)/stdlibConstraintVersion=$CONSTRAINT_VERSION/g" gradle.properties
            - name: Build with Gradle
              env:
                  packageUser: ${{ github.actor }}
                  packagePAT: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  ./gradlew clean build
    build-ballerinax-modules:
        if: inputs.ballerinax_modules != ''
        name: Build Ballerina Extended Module
        continue-on-error: true
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                module: ${{ fromJson(inputs.ballerinax_modules) }}
        steps:
            - name: Set up JDK 11
              uses: actions/setup-java@v3
              with:
                  distribution: 'temurin'
                  java-version: 11

            - name: Checkout dependent Ballerina extended module
              uses: actions/checkout@v3
              id: checkout
              if: ${{ inputs.target_branch != '' }}
              continue-on-error: true
              with:
                  repository: 'ballerina-platform/module-ballerinax-${{ matrix.module }}'
                  ref: ${{ inputs.target_branch }}

            - name: Checkout default branch
              uses: actions/checkout@v3
              if: ${{ inputs.target_branch == '' || steps.checkout.outcome == 'failure' }}
              continue-on-error: true
              with:
                  repository: 'ballerina-platform/module-ballerinax-${{ matrix.module }}'

            - name: Change constraint module version
              run: |
                  CONSTRAINT_VERSION=${{ inputs.timestamped_version }}
                  echo CONSTRAINTVERSION=$CONSTRAINT_VERSION
                  sed -i "s/stdlibConstraintVersion=\(.*\)/stdlibConstraintVersion=$CONSTRAINT_VERSION/g" gradle.properties
            - name: Build with Gradle
              env:
                  packageUser: ${{ github.actor }}
                  packagePAT: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  ./gradlew clean build